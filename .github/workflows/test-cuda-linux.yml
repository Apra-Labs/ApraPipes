name: Test-CUDA-Linux

# Temporary workflow to test CUDA on GPU runner
# Downloads SDK from a Build-Test run and executes tests

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of CI-Linux-Build-Test to download SDK from'
        required: true
        type: string

jobs:
  cuda-tests:
    name: Run CUDA Tests
    runs-on: [self-hosted, linux-cuda]
    timeout-minutes: 45

    steps:
    - name: Cleanup workspace
      run: rm -rf * || true
      continue-on-error: true

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        lfs: true

    - name: Download SDK Artifact
      uses: actions/download-artifact@v4
      with:
        name: aprapipes-sdk-linux-x64
        path: sdk/
        run-id: ${{ github.event.inputs.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: List SDK Contents
      run: |
        echo "=== Downloaded SDK Contents ==="
        ls -la sdk/bin/ || echo "bin empty"
        ls -la sdk/lib/ || echo "lib empty"

    - name: Verify CUDA Environment
      run: |
        echo "=== CUDA Environment Check ==="
        nvcc --version
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv

    - name: Make test executable runnable
      run: chmod +x sdk/bin/aprapipesut

    - name: Run CUDA Tests
      run: |
        # Run from workspace root so tests can find ./data folder
        sdk/bin/aprapipesut --log_format=JUNIT --log_sink=CI_test_result_Linux-CUDA.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 30

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_CUDA-Linux
        path: CI_test_result_Linux-CUDA.xml
