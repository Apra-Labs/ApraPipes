name: CI-Linux-Build-Test

# Phase 2: Build on cloud, test (CUDA tests skip), publish SDK artifact
# CUDA-agnostic - no knowledge of GPU availability
# CUDA tests skip silently via runtime detection (if_compute_cap_supported)
# Triggers CI-Linux-CUDA-Tests on success for GPU testing

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:

# Prevent duplicate runs - cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true

jobs:
  build-test:
    runs-on: ubuntu-22.04  # CRITICAL: GCC 11 for CUDA 11.8 compatibility

    env:
      TEST_EXE: build/aprapipesut
      CMAKE_TC_FILE: '../vcpkg/scripts/buildsystems/vcpkg.cmake'
      VCPKG_MAX_CONCURRENCY: 6
      # CRITICAL: Use /mnt partition to avoid disk exhaustion
      VCPKG_DEFAULT_BINARY_CACHE: /mnt/runner-work/.cache/vcpkg
      # CUDA environment variables - at job level for vcpkg subprocess propagation
      CUDAToolkit_ROOT: '/usr/local/cuda-11.8'
      CUDA_PATH: '/usr/local/cuda-11.8'
      CUDACXX: '/usr/local/cuda-11.8/bin/nvcc'
      # GCC-11 for CUDA 11.8 compatibility (ubuntu-22.04 has GCC 11 by default)
      CC: '/usr/bin/gcc-11'
      CXX: '/usr/bin/g++-11'
      CUDAHOSTCXX: '/usr/bin/g++-11'

    steps:
    - name: Check disk space before cleanup
      run: |
        echo "=== Disk Space BEFORE Cleanup ==="
        df -h

    - name: Free up root partition space
      run: |
        echo "=== Freeing Disk Space on Root Partition ==="
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        echo "=== Root partition cleanup complete ==="

    - name: Check disk space after cleanup
      run: |
        echo "=== Disk Space AFTER Cleanup ==="
        df -h
        echo ""
        echo "=== /mnt partition (will be used for vcpkg cache) ==="
        df -h /mnt

    - name: Install CUDA Toolkit 11.8
      run: |
        echo "=== Installing CUDA Toolkit 11.8 ==="
        wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb
        sudo dpkg -i cuda-keyring_1.0-1_all.deb
        sudo apt-get update
        sudo apt-get -y install cuda-toolkit-11-8

        # Verify CUDA installation
        /usr/local/cuda-11.8/bin/nvcc --version
        echo "CUDA installed successfully"

    - name: Install cuDNN
      run: |
        echo "=== Installing cuDNN (after CUDA repos are added) ==="
        sudo apt-get update -qq
        sudo apt-get -y install libcudnn8-dev

    - name: Prepare builder
      run: |
        sudo apt-get update -qq
        sudo apt-get -y install \
          ca-certificates curl zip unzip tar \
          autoconf autoconf-archive automake autopoint \
          build-essential flex git-core \
          libass-dev libfreetype6-dev libgnutls28-dev \
          libmp3lame-dev libsdl2-dev libtool \
          libsoup-gnome2.4-dev libva-dev libvdpau-dev \
          libvorbis-dev libxdamage-dev libxcb1-dev \
          libxcb-shm0-dev libxcb-xfixes0-dev \
          libncurses5-dev libncursesw5-dev \
          ninja-build pkg-config texinfo wget yasm \
          zlib1g-dev nasm gperf bison \
          python3 python3-pip dos2unix \
          libx11-dev libgles2-mesa-dev \
          libxinerama-dev libxcursor-dev xorg-dev \
          libglu1-mesa-dev python3-jinja2
        pip3 install meson Jinja2

        # Verify compilers
        cmake --version
        ninja --version
        gcc-11 --version
        g++-11 --version
        git --version

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
        fetch-depth: 0
        lfs: true

    - name: List Submodules
      run: |
        git config --global --add safe.directory "*"
        git submodule status > submodule_ver.txt
        cat submodule_ver.txt
        git rev-list --all --count

    - name: Create /mnt work directory and take ownership
      run: |
        echo "=== Creating work directory on /mnt partition ==="
        sudo mkdir -p /mnt/runner-work
        sudo chown -R runner:runner /mnt/runner-work
        df -h /mnt

    - name: Create vcpkg binary cache directory on /mnt
      run: mkdir -p ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}

    - name: Run VCPKG bootstrap
      run: ./vcpkg/bootstrap-vcpkg.sh

    - name: Restore vcpkg cache
      id: cache-restore
      uses: actions/cache/restore@v3
      with:
        path: |
          ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: Linux-Build-Test-1
        restore-keys: Linux-Build-Test-

    - name: Make build folder
      run: mkdir -p build
      continue-on-error: true

    - name: Configure CMake with CUDA
      working-directory: ${{github.workspace}}/build
      run: |
        export PATH=/usr/local/cuda-11.8/bin:$PATH
        cmake -B . -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=${{env.CMAKE_TC_FILE}} \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DENABLE_WINDOWS=OFF \
          -DENABLE_LINUX=ON \
          -DENABLE_CUDA=ON \
          ../base
      continue-on-error: true

    - name: Save vcpkg cache
      if: ${{ always() }}
      uses: actions/cache/save@v3
      with:
        path: |
          ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: Linux-Build-Test-1

    - name: Build
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --config RelWithDebInfo -j 6

    - name: List Test cases
      run: |
        ldd ${{env.TEST_EXE}} | tee >(grep 'not found') || true
        ${{env.TEST_EXE}} --list_content > tests.txt || true
      timeout-minutes: 1

    - name: Run Tests
      run: |
        ${{env.TEST_EXE}} --log_format=JUNIT --log_sink=CI_test_result_Linux-Build-Test.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 20
      # CUDA tests skip silently - this is expected behavior

    - name: Upload Test Results
      if: ${{ always() }}
      continue-on-error: true
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_Linux-Build-Test
        path: |
          CI_test_result_Linux-Build-Test.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**

    - name: Upload build logs
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: BuildLogs_Linux-Build-Test
        path: |
          ${{ github.workspace }}/vcpkg/buildtrees/**/*.log
          ${{ github.workspace }}/vcpkg/buildtrees/**/*.txt
          ${{ github.workspace }}/build/vcpkg-manifest-install.log
          tests.txt
      continue-on-error: true

    # Package and upload SDK artifact for distribution and GPU testing
    - name: Package SDK Artifact
      if: success()
      run: |
        SDK_DIR="${{github.workspace}}/sdk"
        BUILD_DIR="${{github.workspace}}/build"
        INCLUDE_DIR="${{github.workspace}}/base/include"

        # Create SDK directory structure
        mkdir -p "$SDK_DIR/bin"
        mkdir -p "$SDK_DIR/lib"
        mkdir -p "$SDK_DIR/include"

        # Copy binaries (exe + shared libs)
        cp "$BUILD_DIR/aprapipesut" "$SDK_DIR/bin/" || true
        cp "$BUILD_DIR"/*.so* "$SDK_DIR/bin/" 2>/dev/null || true

        # Copy static libraries
        cp "$BUILD_DIR"/*.a "$SDK_DIR/lib/" 2>/dev/null || true

        # Copy headers
        cp -r "$INCLUDE_DIR"/* "$SDK_DIR/include/" 2>/dev/null || true

        # List SDK contents
        echo "=== SDK Contents ==="
        echo "bin/:"
        ls -la "$SDK_DIR/bin/" || echo "  (empty)"
        echo "lib/:"
        ls -la "$SDK_DIR/lib/" || echo "  (empty)"
        echo "include/:"
        ls -la "$SDK_DIR/include/" || echo "  (empty)"

    - name: Upload SDK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: aprapipes-sdk-linux-x64
        path: ${{ github.workspace }}/sdk/
        retention-days: 7

  publish-results:
    name: Publish Test Results
    needs: build-test
    runs-on: ubuntu-latest
    if: always()
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Pull test reporter image
        run: docker pull ghcr.io/enricomi/publish-unit-test-result-action:v2.21.0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts/ || echo "No artifacts"

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2.21.0
        with:
          files: artifacts/**/CI_test_result_*.xml
          check_name: 'Linux Build Tests'

  # Run CUDA tests on self-hosted GPU runner
  cuda-tests:
    name: CUDA Tests
    needs: build-test
    uses: ./.github/workflows/CI-CUDA-Tests.yml
    with:
      os: linux
      run_id: ${{ github.run_id }}
    secrets: inherit
