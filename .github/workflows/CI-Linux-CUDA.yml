name: CI-Linux-CUDA

on:
  push:  # Trigger on push to any branch
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:

env:
  NOTE_TO_SELF: "environments can not be passed from here to reused workflows!"
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  
jobs:
  linux-cuda-build-test:
    uses: ./.github/workflows/build-test-lin.yml
    with:
      runner: 'linux-cuda'
      flav: Linux-CudaT
      is-selfhosted: true
      cuda: 'ON'
      # Use GCC-11 for ffmpeg 4.4.3 compatibility (GCC-12+ has inline assembly issues with ffmpeg 4.4.x)
      prep-cmd: 'cmake --version && ninja --version && gcc-11 --version && g++-11 --version && git --version && pwsh --version'
      prep-check-cmd: 'cmake --version ; ninja --version ; gcc-11 --version ; g++-11 --version ; git --version; pwsh --version'
      bootstrap-cmd: 'export CC=/usr/bin/gcc-11 && export CXX=/usr/bin/g++-11 && ./vcpkg/bootstrap-vcpkg.sh'
      cmake-conf-cmd: 'export CC=/usr/bin/gcc-11 && export CXX=/usr/bin/g++-11 && export CUDAHOSTCXX=/usr/bin/g++-11 && PATH=/usr/local/cuda/bin:$PATH cmake -B . -G Ninja -DCMAKE_C_COMPILER=/usr/bin/gcc-11 -DCMAKE_CXX_COMPILER=/usr/bin/g++-11 -DCMAKE_CUDA_HOST_COMPILER=/usr/bin/g++-11 -DENABLE_WINDOWS=OFF -DENABLE_LINUX=ON ../base'
      cache-path: './none'
      nProc: 20
  linux-cuda-publish:
    needs: linux-cuda-build-test
    if: ${{ always() }}
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: Linux-CudaT
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
