name: CI-Windows-Unified

# Unified Windows build - builds WITH CUDA, detects GPU at runtime
# Replaces separate NoCUDA and CUDA builds
# Tests skip gracefully when GPU/driver unavailable via runtime detection

on:
  push:
    branches:
      - feature/get-rid-of-nocuda-builds
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:

jobs:
  windows-unified-build:
    runs-on: windows-latest

    env:
      TEST_EXE: build/Release/aprapipesut.exe
      CMAKE_TC_FILE: '${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake'
      VCPKG_DEFAULT_BINARY_CACHE: 'C:\Users\runneradmin\AppData\Local\vcpkg\archives'

    steps:
    - name: Install CUDA Toolkit 11.8
      uses: Jimver/cuda-toolkit@v0.2.14
      id: cuda-toolkit
      with:
        cuda: '11.8.0'
        method: 'network'
        sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "thrust", "visual_studio_integration"]'

    - name: Verify CUDA installation
      run: |
        echo "=== CUDA Installation Verification ==="
        nvcc --version
        echo ""
        echo "CUDA_PATH=$env:CUDA_PATH"
        echo "CUDA installation complete"
      shell: pwsh

    - name: Install cuDNN 8.9.7
      run: |
        echo "=== Installing cuDNN 8.9.7 for CUDA 11.8 ==="
        $cudnnUrl = "https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/windows-x86_64/cudnn-windows-x86_64-8.9.7.29_cuda11-archive.zip"
        $cudnnZip = "$env:TEMP\cudnn.zip"
        $cudnnExtract = "$env:TEMP\cudnn"

        # Download cuDNN
        Invoke-WebRequest -Uri $cudnnUrl -OutFile $cudnnZip

        # Extract
        Expand-Archive -Path $cudnnZip -DestinationPath $cudnnExtract -Force

        # Copy files to CUDA installation
        $cudnnDir = Get-ChildItem -Path $cudnnExtract -Directory | Select-Object -First 1
        Copy-Item -Path "$($cudnnDir.FullName)\bin\*" -Destination "$env:CUDA_PATH\bin" -Force
        Copy-Item -Path "$($cudnnDir.FullName)\include\*" -Destination "$env:CUDA_PATH\include" -Force
        Copy-Item -Path "$($cudnnDir.FullName)\lib\*" -Destination "$env:CUDA_PATH\lib\x64" -Force

        # Verify
        if (Test-Path "$env:CUDA_PATH\include\cudnn.h") {
          echo "cuDNN installed successfully"
        } else {
          echo "cuDNN installation may have failed"
        }

        # Cleanup
        Remove-Item -Path $cudnnZip -Force -ErrorAction SilentlyContinue
        Remove-Item -Path $cudnnExtract -Recurse -Force -ErrorAction SilentlyContinue
      shell: pwsh

    - name: Prepare builder
      run: |
        choco install python --version=3.10.11 --force
        refreshenv
        pip3 install ninja
        pip3 install meson
        choco feature enable -n allowEmptyChecksums
        choco install pkgconfiglite
        choco install cmake --version=3.29.6 --force
        python --version
        cmake --version
        ninja --version
        git --version
        pwsh --version

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
        lfs: true
        fetch-depth: 0

    - name: List Submodules
      run: |
        git config --global --add safe.directory "*"
        git submodule status > submodule_ver.txt
        cat submodule_ver.txt
        git rev-list --all --count

    - name: Run VCPKG bootstrap
      run: |
        ./vcpkg/bootstrap-vcpkg.bat
        ./vcpkg/vcpkg.exe integrate install

    - name: Cache dependencies
      id: cache-all
      uses: actions/cache@v3
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: Windows-Unified-5-${{ hashFiles('base/vcpkg.json', 'vcpkg/baseline.json', 'submodule_ver.txt') }}
        restore-keys: Windows-Unified-

    - name: Clear vcpkg downloads to force fresh Python download
      working-directory: ${{github.workspace}}
      run: Remove-Item vcpkg/downloads -Recurse -Force -ErrorAction SilentlyContinue
      shell: pwsh
      continue-on-error: true

    - name: Make build folder
      run: if (!(Test-Path build)) { New-Item -ItemType Directory -Path build }
      shell: pwsh
      continue-on-error: true

    - name: Add pkg-config to PATH
      shell: pwsh
      run: |
        $env:PATH = "C:\ProgramData\chocolatey\bin;$env:PATH"
        echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        Write-Host "Added chocolatey bin to PATH for pkg-config"

    - name: Create vcpkg binary cache directory
      run: if (!(Test-Path "${{env.VCPKG_DEFAULT_BINARY_CACHE}}")) { New-Item -ItemType Directory -Path "${{env.VCPKG_DEFAULT_BINARY_CACHE}}" -Force }
      shell: pwsh
      continue-on-error: true

    - name: Configure CMake with CUDA
      working-directory: ${{github.workspace}}/build
      run: |
        cmake -B . -DENABLE_WINDOWS=ON -DENABLE_LINUX=OFF -A x64 `
          -DCMAKE_TOOLCHAIN_FILE=${{env.CMAKE_TC_FILE}} `
          -DCMAKE_BUILD_TYPE=Release `
          -DENABLE_CUDA=ON `
          ../base
      shell: pwsh

    - name: Remove files not needed for the build
      working-directory: ${{github.workspace}}
      run: |
        Remove-Item vcpkg/downloads -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item * -Recurse -Force -Include *.pdb,*.ilk -ErrorAction SilentlyContinue
      shell: pwsh
      continue-on-error: true

    - name: Build
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --config Release -j 6

    - name: List Test cases
      run: |
        ${{env.TEST_EXE}} --list_content > tests.txt
      timeout-minutes: 1
      continue-on-error: true

    - name: Run Tests
      run: |
        ${{env.TEST_EXE}} --log_format=JUNIT --log_sink=CI_test_result_Windows-Unified.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 20

    - name: Upload Test Results
      if: ${{ always() }}
      continue-on-error: true
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_Windows-Unified
        path: |
          CI_test_result_Windows-Unified.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**

    - name: Upload build logs
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: BuildLogs_Windows-Unified
        path: |
          ${{ github.workspace }}/vcpkg/buildtrees/**/*.log
          ${{ github.workspace }}/vcpkg/buildtrees/**/*.txt
          ${{ github.workspace }}/vcpkg_installed/vcpkg/*
          tests.txt
      continue-on-error: true

  windows-publish:
    name: Publish Tests Results
    needs: windows-unified-build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Pull ghcr.io/enricomi/publish-unit-test-result-action:v2.21.0
        run: docker pull ghcr.io/enricomi/publish-unit-test-result-action:v2.21.0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R
        working-directory: artifacts

      - name: Publish
        uses: EnricoMi/publish-unit-test-result-action@v2.21.0
        with:
          files: artifacts/**/CI_test_result_*.xml
