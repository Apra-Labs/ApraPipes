name: CI-Windows-CUDA-Tests

# Phase 2: Run tests on self-hosted GPU runner
# Triggered by successful CI-Windows-Build-Test workflow
# Downloads SDK artifact and runs ALL tests (CUDA tests now run!)

on:
  workflow_run:
    workflows: ["CI-Windows-Build-Test"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of CI-Windows-Build-Test to download SDK from'
        required: true
        type: string

jobs:
  cuda-tests:
    name: Run CUDA Tests
    # Run if: workflow_run succeeded OR manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted, windows-cuda]
    timeout-minutes: 45

    steps:
    - name: Cleanup workspace
      run: Remove-Item -Recurse -Force * -ErrorAction SilentlyContinue
      shell: pwsh
      continue-on-error: true

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        lfs: true
        # Gets test_data and source code

    - name: Download SDK Artifact
      uses: actions/download-artifact@v4
      with:
        name: aprapipes-sdk-windows-x64
        path: sdk/
        run-id: ${{ github.event.workflow_run.id || github.event.inputs.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: List SDK Contents
      run: |
        echo "=== Downloaded SDK Contents ==="
        echo "bin/:"
        Get-ChildItem "sdk/bin" | ForEach-Object { echo "  $($_.Name)" }
        echo "lib/:"
        Get-ChildItem "sdk/lib" -ErrorAction SilentlyContinue | ForEach-Object { echo "  $($_.Name)" }
        echo "include/:"
        Get-ChildItem "sdk/include" -ErrorAction SilentlyContinue | ForEach-Object { echo "  $($_.Name)" }
      shell: pwsh

    - name: Verify CUDA Environment
      run: |
        echo "=== CUDA Environment Check ==="
        nvcc --version
        echo ""
        echo "GPU Info:"
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv
      shell: pwsh

    - name: Run CUDA Tests
      run: |
        cd sdk/bin
        ./aprapipesut.exe --log_format=JUNIT --log_sink=CI_test_result_Windows-CUDA.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 30
      shell: pwsh

    - name: Upload CUDA Test Results
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_Windows-CUDA
        path: |
          sdk/bin/CI_test_result_Windows-CUDA.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**

  publish-cuda-results:
    name: Publish CUDA Test Results
    needs: cuda-tests
    runs-on: ubuntu-latest
    if: always()
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts/ || echo "No artifacts"

      - name: Publish CUDA Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2.21.0
        with:
          files: artifacts/**/CI_test_result_*.xml
          check_name: 'Windows CUDA Tests'
