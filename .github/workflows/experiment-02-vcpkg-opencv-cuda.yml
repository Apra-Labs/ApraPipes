name: Experiment-02-vcpkg-opencv-cuda

# EXPERIMENT: Can vcpkg build opencv4[cuda] on GitHub runner without GPU?
# SUCCESS CRITERIA:
#   1. vcpkg builds opencv4 with CUDA features
#   2. Build completes without GPU-related errors
#   3. OpenCV libraries are created
#   4. Simple program using cv::cuda compiles and links

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches:
      - feature/get-rid-of-nocuda-builds
    paths:
      - '.github/workflows/experiment-02-vcpkg-opencv-cuda.yml'

jobs:
  test-opencv-cuda-minimal:
    runs-on: ubuntu-22.04  # Use 22.04 for GCC 11 (CUDA 11.8 compatible)

    steps:
      - name: Install CUDA Toolkit
        run: |
          echo "=== Installing CUDA Toolkit 11.8 ==="
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb
          sudo dpkg -i cuda-keyring_1.0-1_all.deb
          sudo apt-get update
          sudo apt-get -y install cuda-toolkit-11-8
          echo "/usr/local/cuda-11.8/bin" >> $GITHUB_PATH
          echo "CUDA_PATH=/usr/local/cuda-11.8" >> $GITHUB_ENV

      # Skip cuDNN for this experiment - just test basic CUDA support
      # cuDNN is optional for opencv4[cuda] with core features only

      - name: Setup vcpkg (minimal)
        run: |
          echo "=== Setting up vcpkg ==="
          git clone https://github.com/microsoft/vcpkg.git vcpkg-test
          cd vcpkg-test
          ./bootstrap-vcpkg.sh

      - name: Create Minimal vcpkg.json
        run: |
          cat > vcpkg-test/vcpkg.json << 'EOF'
          {
            "name": "opencv-cuda-test",
            "version": "0.0.1",
            "dependencies": [
              {
                "name": "opencv4",
                "default-features": false,
                "features": ["cuda"]
              }
            ]
          }
          EOF
          cat vcpkg-test/vcpkg.json

      - name: Build OpenCV with CUDA
        timeout-minutes: 90
        run: |
          echo "=== Building opencv4[cuda] ==="
          cd vcpkg-test

          export PATH=/usr/local/cuda-11.8/bin:$PATH
          export CUDA_PATH=/usr/local/cuda-11.8
          export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH

          # Install opencv4 with CUDA
          ./vcpkg install --triplet=x64-linux

          echo "=== Build Complete ==="

      - name: Verify OpenCV CUDA Build
        run: |
          echo "=== Verifying OpenCV CUDA Libraries ==="
          cd vcpkg-test

          # Check if CUDA modules were built
          find installed/x64-linux -name "*opencv*cuda*" -o -name "*opencv_world*"

          # Check pkg-config
          export PKG_CONFIG_PATH=$(pwd)/installed/x64-linux/lib/pkgconfig:$PKG_CONFIG_PATH
          pkg-config --modversion opencv4 || echo "opencv4.pc not found"

      - name: Test OpenCV CUDA Program
        run: |
          echo "=== Testing OpenCV CUDA Program ==="

          export PATH=/usr/local/cuda-11.8/bin:$PATH
          export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH
          export PKG_CONFIG_PATH=$(pwd)/vcpkg-test/installed/x64-linux/lib/pkgconfig:$PKG_CONFIG_PATH

          # Create test program
          cat > test_opencv_cuda.cpp << 'EOF'
          #include <opencv2/core.hpp>
          #include <opencv2/core/cuda.hpp>
          #include <iostream>

          int main() {
              std::cout << "=== OpenCV CUDA Test ===" << std::endl;
              std::cout << "OpenCV version: " << CV_VERSION << std::endl;

              // Check CUDA device count (will be 0 on GitHub runner)
              int cudaDeviceCount = cv::cuda::getCudaEnabledDeviceCount();
              std::cout << "CUDA devices: " << cudaDeviceCount << std::endl;

              if (cudaDeviceCount == 0) {
                  std::cout << "SUCCESS: OpenCV built with CUDA, no GPU available (expected)" << std::endl;
                  return 0;
              } else {
                  std::cout << "Unexpected: CUDA devices found on GitHub runner" << std::endl;
                  return 0;  // Still success
              }
          }
          EOF

          # Compile
          g++ test_opencv_cuda.cpp -o test_opencv_cuda \
              $(pkg-config --cflags --libs opencv4) \
              -I/usr/local/cuda-11.8/include \
              -L/usr/local/cuda-11.8/lib64 \
              -lcudart

          echo "Compilation successful!"

          # Run
          ./test_opencv_cuda

          echo "=== Test Complete ==="

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "EXPERIMENT 02: RESULTS"
          echo "======================================"
          echo ""
          echo "This experiment validates:"
          echo "  ✓ vcpkg can build opencv4[cuda] without GPU"
          echo "  ✓ OpenCV CUDA modules compile successfully"
          echo "  ✓ cv::cuda::getCudaEnabledDeviceCount() works"
          echo "  ✓ Programs linking OpenCV CUDA run without crash"
          echo ""
          echo "Next Step: Experiment 03 - Full ApraPipes dependencies"
          echo "======================================"
