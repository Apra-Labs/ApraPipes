name: CI-CUDA-Tests

# Phase 2: Run tests on self-hosted GPU runners
# Triggered by:
#   - workflow_call: Called by CI-*-Build-Test for PR validation
#   - workflow_run: Auto-triggered after Build-Test completes on main
#   - workflow_dispatch: Manual trigger for testing

on:
  workflow_call:
    inputs:
      os:
        description: 'Operating system (linux or windows)'
        required: true
        type: string
      run_id:
        description: 'Run ID of Build-Test workflow to download SDK from'
        required: true
        type: string

  workflow_run:
    workflows: ["CI-Windows-Build-Test", "CI-Linux-Build-Test"]
    types: [completed]

  workflow_dispatch:
    inputs:
      os:
        description: 'Operating system'
        required: true
        type: choice
        options:
          - linux
          - windows
      run_id:
        description: 'Run ID of Build-Test workflow to download SDK from'
        required: true
        type: string

jobs:
  # Determine which OS to test based on trigger
  setup:
    runs-on: ubuntu-latest
    outputs:
      os: ${{ steps.set-os.outputs.os }}
      run_id: ${{ steps.set-os.outputs.run_id }}
    steps:
      - id: set-os
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.name }}" == *"Linux"* ]]; then
              echo "os=linux" >> $GITHUB_OUTPUT
            else
              echo "os=windows" >> $GITHUB_OUTPUT
            fi
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          else
            echo "os=${{ inputs.os }}" >> $GITHUB_OUTPUT
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
          fi

  cuda-tests:
    name: Run CUDA Tests (${{ needs.setup.outputs.os }})
    needs: setup
    # Run when:
    # - Called from Build-Test (setup.outputs.os is set from inputs)
    # - Triggered by workflow_run when Build-Test completes successfully
    # - Manually triggered via workflow_dispatch
    # Note: github.event_name is NOT 'workflow_call' when called - it's the caller's event
    if: |
      (needs.setup.outputs.os != '') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    runs-on: ${{ needs.setup.outputs.os == 'linux' && fromJSON('["self-hosted", "linux-cuda"]') || fromJSON('["self-hosted", "windows-cuda"]') }}
    timeout-minutes: 45

    env:
      OS: ${{ needs.setup.outputs.os }}
      SDK_RUN_ID: ${{ needs.setup.outputs.run_id }}

    steps:
    - name: Cleanup workspace (Linux)
      if: needs.setup.outputs.os == 'linux'
      run: rm -rf * || true
      continue-on-error: true

    - name: Cleanup workspace (Windows)
      if: needs.setup.outputs.os == 'windows'
      run: Remove-Item -Recurse -Force * -ErrorAction SilentlyContinue
      shell: pwsh
      continue-on-error: true

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        lfs: true

    - name: Download SDK Artifact
      uses: actions/download-artifact@v4
      with:
        name: aprapipes-sdk-${{ needs.setup.outputs.os == 'linux' && 'linux-x64' || 'windows-x64' }}
        path: sdk/
        run-id: ${{ needs.setup.outputs.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: List SDK Contents (Linux)
      if: needs.setup.outputs.os == 'linux'
      run: |
        echo "=== Downloaded SDK Contents ==="
        ls -la sdk/bin/ || echo "bin empty"
        ls -la sdk/lib/ || echo "lib empty"

    - name: List SDK Contents (Windows)
      if: needs.setup.outputs.os == 'windows'
      run: |
        echo "=== Downloaded SDK Contents ==="
        Get-ChildItem sdk/bin -ErrorAction SilentlyContinue | ForEach-Object { echo "  $($_.Name)" }
        Get-ChildItem sdk/lib -ErrorAction SilentlyContinue | ForEach-Object { echo "  $($_.Name)" }
      shell: pwsh

    - name: Verify CUDA Environment (Linux)
      if: needs.setup.outputs.os == 'linux'
      run: |
        echo "=== CUDA Environment Check ==="
        nvcc --version
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv

    - name: Verify CUDA Environment (Windows)
      if: needs.setup.outputs.os == 'windows'
      run: |
        echo "=== CUDA Environment Check ==="
        nvcc --version
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv
      shell: pwsh

    - name: Make test executable runnable
      if: needs.setup.outputs.os == 'linux'
      run: chmod +x sdk/bin/aprapipesut

    - name: Run CUDA Tests (Linux)
      if: needs.setup.outputs.os == 'linux'
      run: |
        # Run from workspace root so tests find ./data folder
        sdk/bin/aprapipesut --log_format=JUNIT --log_sink=CI_test_result_CUDA.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 30

    - name: Run CUDA Tests (Windows)
      if: needs.setup.outputs.os == 'windows'
      run: |
        # Run from workspace root so tests find ./data folder
        ./sdk/bin/aprapipesut.exe --log_format=JUNIT --log_sink=CI_test_result_CUDA.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 30
      shell: pwsh

    - name: Upload CUDA Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_${{ needs.setup.outputs.os }}-CUDA
        path: |
          CI_test_result_CUDA.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**

  publish-cuda-results:
    name: Publish CUDA Test Results
    needs: [cuda-tests]
    runs-on: ubuntu-latest
    if: always() && needs.cuda-tests.result != 'skipped'
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts/ || echo "No artifacts"

      - name: Publish CUDA Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2.21.0
        with:
          files: artifacts/**/CI_test_result_*.xml
          check_name: 'CUDA Tests'
