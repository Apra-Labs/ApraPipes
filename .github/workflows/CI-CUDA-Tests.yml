name: CI-CUDA-Tests

# Phase 2: Run tests on self-hosted GPU runners
# Triggered by successful Build-Test workflows OR manual dispatch
# Downloads SDK artifact and runs ALL tests (CUDA tests execute on GPU!)

on:
  workflow_run:
    workflows: ["CI-Windows-Build-Test", "CI-Linux-Build-Test"]
    types: [completed]
  workflow_dispatch:
    inputs:
      os:
        description: 'Operating system'
        required: true
        type: choice
        options:
          - linux
          - windows
      run_id:
        description: 'Run ID of Build-Test workflow to download SDK from'
        required: true
        type: string

jobs:
  # Linux CUDA Tests - triggered by CI-Linux-Build-Test or manual with os=linux
  linux-cuda-tests:
    name: Run CUDA Tests (Linux)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && contains(github.event.workflow_run.name, 'Linux')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.os == 'linux')
    runs-on: [self-hosted, linux-cuda]
    timeout-minutes: 45

    steps:
    - name: Cleanup workspace
      run: rm -rf * || true
      continue-on-error: true

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        lfs: true

    - name: Download SDK Artifact
      uses: actions/download-artifact@v4
      with:
        name: aprapipes-sdk-linux-x64
        path: sdk/
        run-id: ${{ github.event.workflow_run.id || github.event.inputs.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: List SDK Contents
      run: |
        echo "=== Downloaded SDK Contents ==="
        ls -la sdk/bin/ || echo "bin empty"
        ls -la sdk/lib/ || echo "lib empty"

    - name: Verify CUDA Environment
      run: |
        echo "=== CUDA Environment Check ==="
        nvcc --version
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv

    - name: Make test executable runnable
      run: chmod +x sdk/bin/aprapipesut

    - name: Run CUDA Tests
      run: |
        # Run from workspace root so tests find ./data folder
        sdk/bin/aprapipesut --log_format=JUNIT --log_sink=CI_test_result_Linux-CUDA.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 30

    - name: Upload CUDA Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_Linux-CUDA
        path: |
          CI_test_result_Linux-CUDA.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**

  # Windows CUDA Tests - triggered by CI-Windows-Build-Test or manual with os=windows
  windows-cuda-tests:
    name: Run CUDA Tests (Windows)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && contains(github.event.workflow_run.name, 'Windows')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.os == 'windows')
    runs-on: [self-hosted, windows-cuda]
    timeout-minutes: 45

    steps:
    - name: Cleanup workspace
      run: Remove-Item -Recurse -Force * -ErrorAction SilentlyContinue
      shell: pwsh
      continue-on-error: true

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        lfs: true

    - name: Download SDK Artifact
      uses: actions/download-artifact@v4
      with:
        name: aprapipes-sdk-windows-x64
        path: sdk/
        run-id: ${{ github.event.workflow_run.id || github.event.inputs.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: List SDK Contents
      run: |
        echo "=== Downloaded SDK Contents ==="
        echo "bin/:"
        Get-ChildItem "sdk/bin" | ForEach-Object { echo "  $($_.Name)" }
        echo "lib/:"
        Get-ChildItem "sdk/lib" -ErrorAction SilentlyContinue | ForEach-Object { echo "  $($_.Name)" }
      shell: pwsh

    - name: Verify CUDA Environment
      run: |
        echo "=== CUDA Environment Check ==="
        nvcc --version
        echo "GPU Info:"
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv
      shell: pwsh

    - name: Run CUDA Tests
      run: |
        # Run from workspace root so tests find ./data folder
        ./sdk/bin/aprapipesut.exe --log_format=JUNIT --log_sink=CI_test_result_Windows-CUDA.xml -p -l all || echo 'test execution returned error'
      timeout-minutes: 30
      shell: pwsh

    - name: Upload CUDA Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_Windows-CUDA
        path: |
          CI_test_result_Windows-CUDA.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**

  # Publish results from whichever job ran
  publish-cuda-results:
    name: Publish CUDA Test Results
    needs: [linux-cuda-tests, windows-cuda-tests]
    runs-on: ubuntu-latest
    if: always() && (needs.linux-cuda-tests.result != 'skipped' || needs.windows-cuda-tests.result != 'skipped')
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts/ || echo "No artifacts"

      - name: Publish CUDA Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2.21.0
        with:
          files: artifacts/**/CI_test_result_*.xml
          check_name: 'CUDA Tests'
