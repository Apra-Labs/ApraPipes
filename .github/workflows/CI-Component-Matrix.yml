name: CI-Component-Matrix

on:
  # Run on schedule (weekly on Sundays)
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      preset:
        description: 'Component preset to test (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - minimal
          - video
          - cuda
          - full

env:
  NOTE: "Component matrix testing - validates component-based build system"

jobs:
  component-matrix-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows CUDA tests
          - runner: windows-cuda
            os: windows
            cuda: 'ON'
            preset: minimal
            flav: 'Win-CUDA-minimal'
            is-selfhosted: true

          - runner: windows-cuda
            os: windows
            cuda: 'ON'
            preset: video
            flav: 'Win-CUDA-video'
            is-selfhosted: true

          - runner: windows-cuda
            os: windows
            cuda: 'ON'
            preset: cuda
            flav: 'Win-CUDA-cuda'
            is-selfhosted: true

          # Windows No-CUDA tests
          - runner: windows-2022
            os: windows
            cuda: 'OFF'
            preset: minimal
            flav: 'Win-NoCUDA-minimal'
            is-selfhosted: false

          - runner: windows-2022
            os: windows
            cuda: 'OFF'
            preset: video
            flav: 'Win-NoCUDA-video'
            is-selfhosted: false

          # Linux CUDA tests
          - runner: linux-cuda
            os: linux
            cuda: 'ON'
            preset: minimal
            flav: 'Linux-CUDA-minimal'
            is-selfhosted: true

          - runner: linux-cuda
            os: linux
            cuda: 'ON'
            preset: video
            flav: 'Linux-CUDA-video'
            is-selfhosted: true

          - runner: linux-cuda
            os: linux
            cuda: 'ON'
            preset: cuda
            flav: 'Linux-CUDA-cuda'
            is-selfhosted: true

    name: ${{ matrix.flav }}
    runs-on: ${{ matrix.runner }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'
        lfs: true
        fetch-depth: 0

    - name: Setup build environment
      shell: bash
      run: |
        echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
        echo "Testing preset: ${{ matrix.preset }}"
        echo "Platform: ${{ matrix.os }}"
        echo "CUDA: ${{ matrix.cuda }}"

    # Windows-specific steps
    - name: Run build script (Windows)
      if: matrix.os == 'windows'
      shell: pwsh
      run: |
        if ("${{ matrix.cuda }}" -eq "ON") {
          .\build_windows_cuda.bat --preset ${{ matrix.preset }}
        } else {
          .\build_windows_no_cuda.bat --preset ${{ matrix.preset }}
        }
      timeout-minutes: 120

    # Linux-specific steps
    - name: Run build script (Linux)
      if: matrix.os == 'linux'
      shell: bash
      run: |
        chmod +x build_linux_*.sh
        if [ "${{ matrix.cuda }}" == "ON" ]; then
          ./build_linux_cuda.sh --preset ${{ matrix.preset }}
        else
          ./build_linux_no_cuda.sh --preset ${{ matrix.preset }}
        fi
      timeout-minutes: 120

    - name: Calculate build time
      shell: bash
      run: |
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        BUILD_MINUTES=$((BUILD_DURATION / 60))
        BUILD_SECONDS=$((BUILD_DURATION % 60))
        echo "Build completed in ${BUILD_MINUTES}m ${BUILD_SECONDS}s"
        echo "BUILD_DURATION_MINS=${BUILD_MINUTES}" >> $GITHUB_ENV
        echo "BUILD_DURATION_SECS=${BUILD_SECONDS}" >> $GITHUB_ENV

    - name: List test cases
      shell: bash
      run: |
        if [ "${{ matrix.os }}" == "windows" ]; then
          ./_build/RelWithDebInfo/aprapipesut.exe --list_content > tests_${{ matrix.preset }}.txt || echo "Test listing failed"
        else
          ./_build/aprapipesut --list_content > tests_${{ matrix.preset }}.txt || echo "Test listing failed"
        fi
      continue-on-error: true

    - name: Run tests
      shell: bash
      run: |
        if [ "${{ matrix.os }}" == "windows" ]; then
          ./_build/RelWithDebInfo/aprapipesut.exe --log_format=JUNIT --log_sink=CI_test_result_${{ matrix.flav }}.xml -p -l all || echo 'test execution returned error'
        else
          ./_build/aprapipesut --log_format=JUNIT --log_sink=CI_test_result_${{ matrix.flav }}.xml -p -l all || echo 'test execution returned error'
        fi
      timeout-minutes: 20
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: ComponentTest_${{ matrix.flav }}
        path: |
          CI_test_result_${{ matrix.flav }}.xml
          tests_${{ matrix.preset }}.txt
      continue-on-error: true

    - name: Generate build summary
      shell: bash
      run: |
        echo "## Component Build Summary: ${{ matrix.flav }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Preset**: ${{ matrix.preset }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CUDA**: ${{ matrix.cuda }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: ${BUILD_DURATION_MINS}m ${BUILD_DURATION_SECS}s" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner**: ${{ matrix.runner }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "tests_${{ matrix.preset }}.txt" ]; then
          TEST_COUNT=$(wc -l < tests_${{ matrix.preset }}.txt || echo "unknown")
          echo "- **Test Count**: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: BuildLogs_${{ matrix.flav }}
        path: |
          vcpkg/buildtrees/**/*.log
          vcpkg/buildtrees/**/*.txt
      continue-on-error: true

  # Aggregate results and track build times
  aggregate-results:
    needs: component-matrix-test
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-results
      continue-on-error: true

    - name: Generate component matrix summary
      shell: bash
      run: |
        echo "## Component Matrix Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Preset | Platform | CUDA | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|----------|------|--------|" >> $GITHUB_STEP_SUMMARY

        # Parse test results from downloaded artifacts
        STATUS="${{ needs.component-matrix-test.result }}"
        if [ "$STATUS" == "success" ]; then
          ICON="✅"
        else
          ICON="❌"
        fi

        # Check individual test results if available
        for dir in test-results/ComponentTest_*/; do
          if [ -d "$dir" ]; then
            TEST_NAME=$(basename "$dir" | sed 's/ComponentTest_//')
            if [ -f "$dir/CI_test_result_*.xml" ]; then
              # Check for test failures in XML
              if grep -q 'failures="0"' "$dir/CI_test_result_*.xml" 2>/dev/null; then
                echo "| $TEST_NAME | $ICON |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $TEST_NAME | ❌ |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| $TEST_NAME | ⚠️ No results |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Overall Status**: $ICON" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: Component-based builds reduce build times by 60-80% compared to full builds." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For detailed results, check the individual job logs and test artifacts." >> $GITHUB_STEP_SUMMARY
