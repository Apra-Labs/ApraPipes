name: CI-MacOSX-NoCUDA

on:
  push:
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      force-cache-update:
        description: 'Force cache rebuild (deletes old cache and builds fresh)'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NOTE_TO_SELF: "environments can not be passed from here to reused workflows!"

permissions:
  actions: write  # Required for cache deletion via gh cache delete
  contents: read  # Required for checkout
  checks: write
  pull-requests: write

jobs:
  ci:
    # TEMPORARY: Skip macOS builds on cpp17-modernization branch to save CI resources
    if: ${{ !contains(github.head_ref, 'cpp17-modernization') && !contains(github.ref, 'cpp17-modernization') }}
    uses: ./.github/workflows/build-test-macosx.yml
    with:
      runner: '["macos-15-intel"]'
      flav: MacOSX
      cuda: 'OFF'
      is-selfhosted: false
      is-prep-phase: false
      nProc: 3
      force-cache-update: ${{ inputs.force-cache-update == true }}

  report:
    needs: ci
    if: always()
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: MacOSX
      check_prefix: CI-Mac
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
