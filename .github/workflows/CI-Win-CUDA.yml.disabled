name: CI-Win-CUDA

on:
  push:  # Trigger on push to any branch
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      force-cache-update:
        description: 'Force cache rebuild (deletes old cache and builds fresh)'
        required: false
        type: boolean
        default: false

env:
  NOTE_TO_SELF: "environments can not be passed from here to reused workflows!"

permissions:
  actions: write  # Required for cache deletion via gh cache delete
  contents: read  # Required for checkout

jobs:
  win-cuda-build-test:
    uses: ./.github/workflows/build-test-win.yml
    with:
      runner: '["windows-cuda"]'
      flav: 'Windows-cuda'
      cuda: 'ON'
      is-selfhosted: true
      nProc: 8
      nTestTimeoutMins: 45
      force-cache-update: ${{ inputs.force-cache-update == true }}
      # Self-hosted runner has Python 3.10.11, CMake 3.29.6, and ninja pre-installed
      # Only upgrade pip packages and ensure pkgconfiglite is available
      prep-cmd: 'python --version && cmake --version && pip3 install --upgrade ninja meson && choco feature enable -n allowEmptyChecksums && choco install pkgconfiglite'
  win-cuda-publish:
    needs: win-cuda-build-test
    if: ${{ always() }}
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: 'Windows-cuda'
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}      
