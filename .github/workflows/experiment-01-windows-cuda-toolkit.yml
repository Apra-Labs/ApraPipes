name: Experiment-01-Windows-CUDA-Toolkit

# EXPERIMENT: Can we install CUDA toolkit on windows-latest without GPU?
# GOAL: Test if Jimver/cuda-toolkit action works on Windows GitHub runners
# SUCCESS CRITERIA:
#   1. CUDA toolkit installs without errors
#   2. nvcc compiler is available
#   3. Simple CUDA code compiles
#   4. cudaGetDeviceCount() runs without crash (returns 0 devices is OK)

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches:
      - feature/get-rid-of-nocuda-builds
    paths:
      - '.github/workflows/experiment-01-windows-cuda-toolkit.yml'

jobs:
  test-cuda-install-windows:
    runs-on: windows-latest

    steps:
      - name: Check Windows Version
        run: |
          echo "=== Windows Environment ==="
          systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
          echo.
          echo "Visual Studio:"
          where cl 2>nul && echo "cl.exe found" || (echo "cl.exe not in PATH" && exit /b 0)
        shell: cmd

      - name: Install CUDA Toolkit 11.8 using Jimver action
        uses: Jimver/cuda-toolkit@v0.2.29
        id: cuda-toolkit
        with:
          cuda: '11.8.0'
          sub-packages: '["nvcc", "cudart", "visual_studio_integration"]'

      - name: Verify CUDA Installation
        run: |
          echo "=== Verifying CUDA Installation ==="
          echo "CUDA_PATH=$env:CUDA_PATH"
          nvcc --version
        shell: pwsh

      - name: Test CUDA Compilation
        run: |
          echo "=== Testing CUDA Compilation ==="

          REM Create simple CUDA test program
          (
          echo #include ^<cuda_runtime.h^>
          echo #include ^<stdio.h^>
          echo.
          echo int main^(^) {
          echo     printf^("=== CUDA Runtime Test ^(Windows^) ===\n"^);
          echo.
          echo     int deviceCount = 0;
          echo     cudaError_t error = cudaGetDeviceCount^(^&deviceCount^);
          echo.
          echo     printf^("cudaGetDeviceCount returned: %%d ^(%%s^)\n", error, cudaGetErrorString^(error^)^);
          echo     printf^("Device count: %%d\n", deviceCount^);
          echo.
          echo     if ^(error == cudaSuccess^) {
          echo         printf^("SUCCESS: CUDA runtime works ^(no GPU is OK^)\n"^);
          echo         return 0;
          echo     } else if ^(error == cudaErrorNoDevice ^|^| error == cudaErrorInsufficientDriver^) {
          echo         printf^("SUCCESS: CUDA runtime works, no GPU available ^(expected on GitHub runner^)\n"^);
          echo         return 0;
          echo     } else {
          echo         printf^("FAILURE: Unexpected CUDA error\n"^);
          echo         return 1;
          echo     }
          echo }
          ) > test_cuda.cu

          REM Setup Visual Studio environment with v142 toolset (VS 2019, officially supported by CUDA 11.8)
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64 -vcvars_ver=14.29
          nvcc test_cuda.cu -o test_cuda.exe
          if errorlevel 1 (
            echo Compilation failed!
            exit /b 1
          )
          echo Compilation successful!

          REM Run the test
          test_cuda.exe
        shell: cmd

      - name: Test CUDA Static Runtime Linking
        run: |
          echo "=== Testing Static CUDA Runtime ==="

          REM Create test with static runtime
          (
          echo #include ^<cuda_runtime.h^>
          echo #include ^<stdio.h^>
          echo.
          echo __global__ void dummy_kernel^(^) {
          echo     // Empty kernel for testing
          echo }
          echo.
          echo int main^(^) {
          echo     printf^("=== Static Runtime Test ^(Windows^) ===\n"^);
          echo.
          echo     // Test device query
          echo     int deviceCount = 0;
          echo     cudaError_t error = cudaGetDeviceCount^(^&deviceCount^);
          echo     printf^("Device count query: %%s\n", cudaGetErrorString^(error^)^);
          echo.
          echo     // Test memory allocation ^(will fail without GPU, but shouldn't crash^)
          echo     void* ptr = 0;
          echo     error = cudaMalloc^(^&ptr, 1024^);
          echo     printf^("cudaMalloc: %%s ^(failure expected without GPU^)\n", cudaGetErrorString^(error^)^);
          echo     if ^(ptr^) cudaFree^(ptr^);
          echo.
          echo     printf^("SUCCESS: Static runtime links and runs\n"^);
          echo     return 0;
          echo }
          ) > test_static.cu

          REM Setup Visual Studio environment with v142 toolset (VS 2019, officially supported by CUDA 11.8)
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64 -vcvars_ver=14.29
          nvcc test_static.cu -o test_static.exe -cudart static
          if errorlevel 1 (
            echo Static linking failed!
            exit /b 1
          )
          echo Static linking successful!

          REM Run test
          test_static.exe
        shell: cmd

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "EXPERIMENT 01 (WINDOWS): RESULTS"
          echo "======================================"
          echo ""
          echo "This experiment validates:"
          echo "  ✓ CUDA toolkit can be installed on Windows GitHub runners"
          echo "  ✓ Jimver/cuda-toolkit action works on Windows"
          echo "  ✓ nvcc compiler works without GPU hardware"
          echo "  ✓ CUDA runtime API compiles and links"
          echo "  ✓ cudaGetDeviceCount() runs without crash"
          echo "  ✓ Static CUDA runtime works"
          echo ""
          echo "Next Step: Experiment 02 - Test what vcpkg finds for CUDA"
          echo "======================================"
        shell: pwsh
