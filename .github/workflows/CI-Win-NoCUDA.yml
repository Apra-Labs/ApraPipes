name: CI-Win-NoCUDA

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  NOTE_TO_SELF: "environments can not be passed from here to reused workflows!"
  
jobs:
  win-nocuda-build-prep:
    uses: ./.github/workflows/build-test-win.yml
    with:
      runner: 'windows-2022'
      flav: 'Win-nocuda'
      cuda: 'OFF'
      is-selfhosted: false
      is-prep-phase: true
      nProc: 3
      prep-check-cmd: 'python --version ; cmake --version ; ninja --version ; git --version; pwsh --version ; exit 1'
  win-nocuda-build-test:
    needs: win-nocuda-build-prep
    uses: ./.github/workflows/build-test-win.yml
    with:
      runner: 'windows-2022'
      flav: 'Win-nocuda'
      is-selfhosted: false
      cuda: 'OFF'
      is-prep-phase: false
      nProc: 3
  win-nocuda-publish:
    needs: win-nocuda-build-test
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: 'Win-nocuda'
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}

  win-nocuda-autofix:
    needs: [win-nocuda-build-prep, win-nocuda-build-test]
    if: |
      always() &&
      (
        (startsWith(github.ref_name, 'autonomous-fix-')) ||
        (contains(needs.*.result, 'failure'))
      )
    permissions:
      contents: write
      pull-requests: write
      issues: write
    uses: ./.github/workflows/autonomous-autofix.yml
    with:
      build-flavor: 'Win-nocuda'
      artifact-name: 'BuildLogs_Win-nocuda_1'
      build-status: ${{ !contains(needs.*.result, 'failure') && 'success' || 'failure' }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}      
