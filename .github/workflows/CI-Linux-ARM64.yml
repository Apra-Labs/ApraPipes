name: CI-Linux-ARM64

on:
  push:  # Trigger on push to any branch
    branches-ignore:
      - fix/ci-additional-workflows  # Ignore push events on this CI fix branch
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - 'docs/**'
  workflow_dispatch:

env:
  NOTE_TO_SELF: "environments can not be passed from here to reused workflows!"
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  
jobs:
  jetson-build-test:
    uses: ./.github/workflows/build-test-lin.yml
    with:
      runner: AGX
      flav: Linux_ARM64
      is-selfhosted: true
      cuda: 'ON'
      prep-cmd: |
        echo "=== Jetson ARM64 Build Environment Check ==="
        echo "Note: This runner cannot use sudo in workflows (security)"
        echo "Prerequisites should be installed manually via SSH"
        echo ""

        # Force curl to use HTTP/1.1 for vcpkg downloads (curl 7.58 has HTTP/2 bugs)
        echo "http1.1" > ~/.curlrc
        echo "  ✓ Created ~/.curlrc to force HTTP/1.1 for vcpkg"
        echo ""

        # Check/document required tools
        echo "Checking PowerShell..."
        if ! command -v pwsh &> /dev/null; then
          echo "  ⚠️  PowerShell not found"
          echo "  Manual install: sudo apt install -y wget"
          echo "    wget https://github.com/PowerShell/PowerShell/releases/download/v7.2.23/powershell-7.2.23-linux-arm64.tar.gz"
          echo "    sudo mkdir -p /opt/microsoft/powershell/7"
          echo "    sudo tar zxf powershell-7.2.23-linux-arm64.tar.gz -C /opt/microsoft/powershell/7"
          echo "    sudo chmod +x /opt/microsoft/powershell/7/pwsh"
          echo "    sudo ln -sf /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh"
        else
          echo "  ✓ PowerShell $(pwsh --version)"
        fi

        echo ""
        echo "Checking curl version (need >=8.0 for HTTP/2)..."
        curl_version=$(curl --version | head -1 | grep -oP 'curl \K[0-9.]+' || echo "unknown")
        echo "  Current: curl $curl_version"
        if [[ "$curl_version" < "8.0" ]]; then
          echo "  ⚠️  Using HTTP/1.1 fallback (old curl has HTTP/2 issues)"
          echo "  Recommended: Upgrade to curl 8.11+ for better performance"
          echo "  Manual install: See .github/docs/jetson-setup.md"
        else
          echo "  ✓ curl version supports HTTP/2"
        fi

        echo ""
        echo "Checking autotools (required for vcpkg builds)..."
        missing_tools=()
        command -v autoconf &> /dev/null || missing_tools+=("autoconf")
        command -v automake &> /dev/null || missing_tools+=("automake")
        command -v libtoolize &> /dev/null || missing_tools+=("libtool")
        command -v autopoint &> /dev/null || missing_tools+=("autopoint")

        if [ ${#missing_tools[@]} -eq 0 ]; then
          autoconf_ver=$(autoconf --version | head -1 | grep -oP '[0-9.]+')
          echo "  ✓ autotools installed (autoconf $autoconf_ver, automake, libtool)"

          # Check autoconf version (need 2.70+)
          if [[ "$autoconf_ver" < "2.70" ]]; then
            echo "  ⚠️  autoconf $autoconf_ver is too old (need 2.70+)"
            echo "  Manual upgrade: cd /tmp && wget https://ftp.gnu.org/gnu/autoconf/autoconf-2.71.tar.gz"
            echo "    tar -xzf autoconf-2.71.tar.gz && cd autoconf-2.71"
            echo "    ./configure --prefix=/usr/local && make -j\$(nproc) && sudo make install"
          fi
        else
          echo "  ⚠️  Missing autotools: ${missing_tools[*]}"
          echo "  Manual install: sudo apt-get install -y autoconf-archive automake libtool"
          echo "  Note: libtoolize comes from the 'libtool' package"
          echo "  Manual install autoconf 2.71: cd /tmp && wget https://ftp.gnu.org/gnu/autoconf/autoconf-2.71.tar.gz"
          echo "    tar -xzf autoconf-2.71.tar.gz && cd autoconf-2.71"
          echo "    ./configure --prefix=/usr/local && make -j\$(nproc) && sudo make install"
        fi
      bootstrap-cmd: |
        export VCPKG_FORCE_SYSTEM_BINARIES=1 && ./vcpkg/bootstrap-vcpkg.sh
        # Pre-download OpenCV dependencies with HTTP/1.1 to work around curl 7.58.0 bugs
        echo "Pre-caching OpenCV dependencies (HTTP/1.1 fallback for curl 7.58)..."
        mkdir -p vcpkg/downloads/opencv-cache/tiny_dnn
        TINY_DNN="vcpkg/downloads/opencv-cache/tiny_dnn/adb1c512e09ca2c7a6faef36f9c53e59-v1.0.0a3.tar.gz"
        if [ ! -f "$TINY_DNN" ]; then
          curl --http1.1 --retry 5 --retry-delay 3 -L -o "$TINY_DNN" \
            "https://github.com/tiny-dnn/tiny-dnn/archive/v1.0.0a3.tar.gz" && echo "✓ tiny-dnn cached" || \
          curl --http1.1 --retry 5 --retry-delay 3 -L -o "$TINY_DNN" \
            "https://github.com/tiny-dnn/tiny-dnn/archive/v1.0.0a3.tar.gz"
        fi
      cache-path: './none'
      cmake-conf-cmd: 'export VCPKG_OVERLAY_PORTS=../thirdparty/arm64-overlay && export CURL_HTTP_VERSION=HTTP/1.1 && export CC=/usr/bin/gcc-8 && export CXX=/usr/bin/g++-8 && cmake -B . -G Ninja -DCMAKE_C_COMPILER=/usr/bin/gcc-8 -DCMAKE_CXX_COMPILER=/usr/bin/g++-8 -DENABLE_ARM64=ON ../base'
      nProc: 6
  jetson-publish:
    needs: jetson-build-test
    if: ${{ always() }}
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: Linux_ARM64
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
