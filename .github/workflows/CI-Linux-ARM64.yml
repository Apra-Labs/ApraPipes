name: CI-Linux-ARM64

on:
  push:  # Trigger on push to any branch
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:

env:
  NOTE_TO_SELF: "environments can not be passed from here to reused workflows!"
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  
jobs:
  jetson-build-test:
    uses: ./.github/workflows/build-test-lin.yml
    with:
      runner: '["self-hosted", "Linux", "ARM64"]'
      flav: Linux_ARM64
      is-selfhosted: true
      cuda: 'ON'
      prep-cmd: |
        echo "=== Jetson ARM64 Build Environment Check (Ubuntu 20.04) ==="
        echo "Runner: AGX (JetPack 5.0, CUDA 11.4)"
        echo ""

        # Check disk space
        echo "=== Disk Space Check ==="
        df -h / /data 2>/dev/null || df -h
        echo ""

        # Install autoconf 2.71 from source if needed (Ubuntu 20.04 has 2.69, vcpkg gperf requires 2.70+)
        AUTOCONF_VERSION=$(autoconf --version 2>/dev/null | head -1 | grep -oP '\d+\.\d+' || echo "0")
        if [ "$(echo "$AUTOCONF_VERSION < 2.70" | bc)" -eq 1 ]; then
          echo "=== Installing autoconf 2.71 from source ==="
          cd /tmp
          wget -q https://ftp.gnu.org/gnu/autoconf/autoconf-2.71.tar.xz
          tar xf autoconf-2.71.tar.xz
          cd autoconf-2.71
          ./configure --prefix=/usr/local >/dev/null
          make -j$(nproc) >/dev/null
          sudo make install >/dev/null
          hash -r
          echo "autoconf upgraded to: $(autoconf --version | head -1)"
          cd -
        fi

        # Full version check
        echo "=== Tool Versions ==="
        echo "git:        $(git --version 2>/dev/null || echo 'MISSING')"
        echo "git-lfs:    $(git lfs --version 2>/dev/null || echo 'MISSING')"
        echo "cmake:      $(cmake --version | head -1)"
        echo "ninja:      ninja $(ninja --version)"
        echo "gcc:        $(gcc --version | head -1)"
        echo "g++:        $(g++ --version | head -1)"
        echo "autoconf:   $(autoconf --version | head -1)"
        echo "automake:   $(automake --version | head -1)"
        echo "libtool:    $(libtoolize --version | head -1)"
        echo "pkg-config: $(pkg-config --version)"
        echo "pwsh:       $(pwsh --version 2>/dev/null || echo 'MISSING')"
        echo "nvcc:       $(/usr/local/cuda/bin/nvcc --version 2>/dev/null | tail -1 || echo 'MISSING')"
        echo ""

        # Check cuDNN
        echo "=== CUDA/cuDNN Check ==="
        ls -la /usr/local/cuda 2>/dev/null | head -3 || echo "CUDA not found"
        ls /usr/include/cudnn*.h 2>/dev/null && echo "cuDNN headers OK" || echo "cuDNN headers MISSING"
        echo ""
      bootstrap-cmd: |
        export VCPKG_FORCE_SYSTEM_BINARIES=1
        ./vcpkg/bootstrap-vcpkg.sh
      cache-path: '/data/.cache/vcpkg'
      cmake-conf-cmd: 'export VCPKG_OVERLAY_PORTS=../thirdparty/arm64-overlay && cmake -B . -G Ninja -DENABLE_ARM64=ON ../base'
      vcpkg-triplet: 'arm64-linux-release'
      nProc: 6
      nTestTimeoutMins: 45  # ARM64 CPU is slower than x64, needs more time for tests
  jetson-publish:
    needs: jetson-build-test
    if: ${{ always() }}
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: Linux_ARM64
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
