name: CI-Linux-ARM64

on:
  push:
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/docs/**'
      - '.claude/**'
      - 'docs/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true

# Permissions needed by nested jobs
permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  ci:
    uses: ./.github/workflows/build-test-lin.yml
    with:
      runner: '["self-hosted", "Linux", "ARM64"]'
      flav: Linux_ARM64
      is-selfhosted: true
      cuda: 'ON'
      prep-cmd: |
        echo "=== ARM64 Build Environment ==="
        df -h / /data 2>/dev/null || df -h
        echo ""
        echo "=== Tool Versions ==="
        cmake --version | head -1
        ninja --version
        gcc --version | head -1
        autoconf --version | head -1
        /usr/local/cuda/bin/nvcc --version 2>/dev/null | tail -1 || echo "nvcc: MISSING"
        echo ""
      bootstrap-cmd: |
        export VCPKG_FORCE_SYSTEM_BINARIES=1
        ./vcpkg/bootstrap-vcpkg.sh
      cache-path: '/data/.cache/vcpkg'
      cmake-conf-cmd: 'export VCPKG_OVERLAY_PORTS=../thirdparty/arm64-overlay && cmake -B . -G Ninja -DENABLE_ARM64=ON ../base'
      vcpkg-triplet: 'arm64-linux-release'
      build-node-addon: false
      nProc: 6
      nTestTimeoutMins: 45

  report:
    needs: ci
    if: always()
    permissions:
      checks: write
      pull-requests: write
    uses: ./.github/workflows/publish-test.yml
    with:
      flav: Linux_ARM64
      check_prefix: CI-ARM
    secrets:
      GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
