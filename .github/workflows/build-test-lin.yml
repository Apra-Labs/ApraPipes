on:
  workflow_call:
    inputs:
      runner:
        type: string
        description: 'runner where this job will run'
        required: true
      flav: 
        type: string
        description: 'flavour of the build: Windows/linux_x64/linux_arm64'
        required: true
      buildConf:
        type: string
        description: 'build configuration e.g. Release/Debug etc.'
        default: 'RelWithDebInfo'
        required: false
      is-selfhosted: 
        type: boolean
        description: 'self hosted runners do not need to use cache'
        required: true
      skip-test: 
        type: boolean
        description: 'should test steps be skipped'
        default: false
        required: false
      cuda: 
        type: string
        description: 'ON/OFF based on this runner support cuda'
        required: true
      prep-cmd:
        type: string
        description: 'commands required to be run on a builder to prep it for build'
        default: 'sudo apt-get update -qq && sudo apt-get -y install ca-certificates curl zip unzip tar  autoconf  autoconf-archive  automake  autopoint build-essential  flex git-core   libass-dev   libfreetype6-dev   libgnutls28-dev   libmp3lame-dev   libsdl2-dev   libtool   libsoup-gnome2.4-dev   libva-dev   libvdpau-dev   libvorbis-dev   libxdamage-dev   libxcb1-dev   libxcb-shm0-dev   libxcb-xfixes0-dev libncurses5-dev libncursesw5-dev  ninja-build   pkg-config   texinfo   wget   yasm   zlib1g-dev   nasm   gperf  bison python3 python3-pip dos2unix libx11-dev libgles2-mesa-dev libxinerama-dev libxcursor-dev xorg-dev libglu1-mesa-dev python3-jinja2 && (pip3 install --break-system-packages meson 2>/dev/null || pip3 install meson) && (pip3 install --break-system-packages Jinja2 2>/dev/null || pip3 install Jinja2)'
        required: false
      prep-check-cmd:
        type: string
        description: 'command to check if the builder is ready'
        default: 'cmake --version ; ninja --version ; gcc --version ; git --version; pwsh --version ||true '
        #pwsh is required on self hosted runners: see here: https://learn.microsoft.com/en-us/powershell/scripting/install/install-other-linux?view=powershell-7.2#installation-using-a-binary-archive-file     
        required: false
      bootstrap-cmd:
        type: string
        description: 'commands required to boot strap builder after code checkout'
        default: './vcpkg/bootstrap-vcpkg.sh'
        required: false
      is-prep-phase:
        type: boolean
        description: 'this workflow is called for a prep phase: it will split vcpkg install into 2 portions to cache and save'
        default: false
        required: false
      cache-path:
        type: string
        description: 'the folder which needs to be cached e.g. .cache/vcpkg'
        default: '../.cache/vcpkg'
        required: false
      cmake-conf-cmd:
        type: string
        description: 'command needed for installing and configuring cmake'
        default: 'PATH=/usr/local/cuda/bin:$PATH ; cmake -B . -DENABLE_WINDOWS=OFF -DENABLE_LINUX=ON ../base'
        required: false
      nProc:
        type: number
        description: 'number of threads to be used by cmake/make'
        default: 6
        required: false
      nTestTimeoutMins:
        type: number
        description: 'number of mins of timeout for tests run'
        default: 20
        required: false
      force-cache-update:
        type: boolean
        description: 'force cache update after CMake configure by deleting old cache and saving new one (use when cache is incomplete/stale)'
        default: false
        required: false
      vcpkg-triplet:
        type: string
        description: 'vcpkg triplet for release-only builds (e.g., x64-linux-release, arm64-linux-release)'
        default: 'x64-linux-release'
        required: false
jobs:
  build:
    env:
      TEST_EXE: build/aprapipesut
      CMAKE_TC_FILE: '../vcpkg/scripts/buildsystems/vcpkg.cmake' # Note: naming this variable as CMAKE_TOOLCHAIN_FILE can cause havoc!!!
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
      VCPKG_MAX_CONCURRENCY: ${{ inputs.nProc }}  # Use nProc for vcpkg parallel builds during CMake configure
      # VCPKG_DEFAULT_BINARY_CACHE is set in the "Create vcpkg binary cache directory" step
      # to avoid vcpkg validation errors before the directory is created
      # XDG_CACHE_HOME redirects ALL caches (including vcpkg registries) to /data on ARM64 Jetson runners
      # This is critical for Jetson where root filesystem has limited space but /data has 100GB+
      # Only set XDG_CACHE_HOME if cache-path starts with /data (ARM64 Jetson runners)
      # Do NOT set for x64 self-hosted runners (they don't have /data)
      XDG_CACHE_HOME: ${{ startsWith(inputs.cache-path, '/data') && '/data/.cache' || '' }}
      # CUDA environment variables - needed for vcpkg opencv4 to detect CUDA
      # These must be at job level so they propagate to vcpkg subprocesses
      # Uses /usr/local/cuda symlink to work with both CUDA 11.8 (x64) and CUDA 11.4 (ARM64)
      # Empty values are harmless for these CUDA-specific variables
      CUDAToolkit_ROOT: ${{ contains(inputs.cuda, 'ON') && '/usr/local/cuda' || '' }}
      CUDA_PATH: ${{ contains(inputs.cuda, 'ON') && '/usr/local/cuda' || '' }}
      CUDACXX: ${{ contains(inputs.cuda, 'ON') && '/usr/local/cuda/bin/nvcc' || '' }}
    runs-on: ${{ fromJson(inputs.runner) }}
    steps:
    - name: Prepare builder
      run: |
        ${{ inputs.prep-cmd }}
        apt purge cmake || true
        (pip3 install --break-system-packages cmake==3.29.6 2>/dev/null || pip3 install cmake==3.29.6) || echo 'did not update cmake'
        ${{ inputs.prep-check-cmd }} 
    
    - name: Check builder for CUDA
      if: ${{ contains(inputs.cuda,'ON')}}
      run: |
        (PATH=/usr/local/cuda/bin:$PATH && nvcc --version) || echo 'please install cuda and add /usr/local/cuda/bin into path'
        # cuDNN headers may be in /usr/local/cuda/include or /usr/include (JetPack)
        test -f /usr/local/cuda/include/cudnn.h || test -f /usr/include/cudnn.h || echo 'install cudnn as described in the readme.md'

    - name: Cleanup workspace on self hosted runners
      if: inputs.is-selfhosted
      run: 'Remove-Item -Recurse -Force *'
      shell: pwsh
      continue-on-error: true

    - name: Checkout code
      uses: actions/checkout@v3
      with: 
        submodules: 'recursive' 
        fetch-depth: 0

    - name: List Submodules
      run: |
        git config --global --add safe.directory "*"
        git submodule status > submodule_ver.txt
        cat submodule_ver.txt
        git rev-list --all --count

    - name: Free disk space on root filesystem (self-hosted runners with limited root disk)
      if: inputs.is-selfhosted
      run: |
        echo "=== Root filesystem before cleanup ==="
        df -h /
        # Clean up old vcpkg registries cache in home directory (now using XDG_CACHE_HOME)
        rm -rf ~/.cache/vcpkg/registries 2>/dev/null || true
        # Clean apt cache
        sudo apt-get clean 2>/dev/null || true
        # Remove old pip cache
        rm -rf ~/.cache/pip 2>/dev/null || true
        echo "=== Root filesystem after cleanup ==="
        df -h /

    - name: Create vcpkg binary cache directory
      run: |
        # Create cache directory and set env var (must be done here, not at job level,
        # because vcpkg validates the directory exists at job startup)
        # IMPORTANT: Must use absolute path because CMake runs from build/ subdirectory
        CACHE_DIR="${{ inputs.cache-path }}"
        echo "Input cache-path: $CACHE_DIR"

        # Convert to absolute path if relative
        if [[ "$CACHE_DIR" == /* ]]; then
          # Already absolute (e.g., /data/.cache/vcpkg for ARM64)
          echo "Path is already absolute: $CACHE_DIR"
        else
          # Relative path - convert to absolute using github.workspace
          # Remove leading ../ or ./ and prepend workspace
          CLEAN_PATH="${CACHE_DIR#../}"  # Remove ../ prefix if present
          CLEAN_PATH="${CLEAN_PATH#./}"   # Remove ./ prefix if present
          CACHE_DIR="${{ github.workspace }}/${CLEAN_PATH}"
          echo "Converted relative to absolute: $CACHE_DIR"
        fi

        mkdir -p "$CACHE_DIR"
        echo "VCPKG_DEFAULT_BINARY_CACHE=$CACHE_DIR" >> $GITHUB_ENV
        echo "Created vcpkg cache directory: $CACHE_DIR"

        # Also create XDG cache dir for vcpkg registries (ARM64 Jetson only)
        if [ -n "$XDG_CACHE_HOME" ]; then
          mkdir -p "$XDG_CACHE_HOME/vcpkg"
          echo "Created XDG cache directory: $XDG_CACHE_HOME/vcpkg"
        fi

    - name: Run VCPKG bootstrap
      run: ${{ inputs.bootstrap-cmd }}

    - name: Remove CUDA from vcpkg if we are in nocuda
      if: ${{ contains(inputs.cuda,'OFF')}}
      working-directory: ${{github.workspace}}/base
      run: .\fix-vcpkg-json.ps1 -removeCUDA
      shell: pwsh

    - name: Set GCC-11 for CUDA 11.8 compatibility (x64 only)
      if: ${{ contains(inputs.cuda,'ON') }}
      run: |
        # CUDA 11.8 requires GCC <= 11, but Ubuntu 24.04 has GCC 13 by default
        # Jetson ARM64 with CUDA 11.4 works fine with GCC 9, so skip if gcc-11 not present
        if [ -x /usr/bin/gcc-11 ]; then
          echo "GCC-11 found, using it for CUDA 11.8 compatibility"
          echo "CC=/usr/bin/gcc-11" >> $GITHUB_ENV
          echo "CXX=/usr/bin/g++-11" >> $GITHUB_ENV
          echo "CUDAHOSTCXX=/usr/bin/g++-11" >> $GITHUB_ENV
        else
          echo "GCC-11 not found, using default compiler (OK for CUDA 11.4)"
          gcc --version | head -1
        fi

    - name: Cache dependencies for fast cloud build
      id: cache-all
      if: ${{ !inputs.is-selfhosted && !inputs.force-cache-update }}
      uses: actions/cache@v3
      with:
          path: |
            ${{ inputs.cache-path }}
          key:  ${{ inputs.flav }}-5-${{ hashFiles( 'base/vcpkg.json', 'vcpkg/baseline.json', 'submodule_ver.txt') }}
          restore-keys: ${{ inputs.flav }}-

    - name: Force cache update - restore and delete old cache
      id: cache-force-restore
      if: ${{ !inputs.is-selfhosted && inputs.force-cache-update }}
      uses: actions/cache/restore@v3
      with:
          path: |
            ${{ inputs.cache-path }}
          key:  ${{ inputs.flav }}-5-${{ hashFiles( 'base/vcpkg.json', 'vcpkg/baseline.json', 'submodule_ver.txt') }}
          restore-keys: ${{ inputs.flav }}-

    # Cache deletion removed - gh cache delete requires workflow-level permissions that are not available in reusable workflows
    # To force cache updates: manually delete caches via GitHub UI or use workflow_dispatch with force-cache-update flag

    - name: Make build folder
      run: mkdir -p build
      continue-on-error: true

    - name: Configure CMake Common
      working-directory: ${{github.workspace}}/build
      run: '${{ inputs.cmake-conf-cmd }} -DVCPKG_TARGET_TRIPLET=${{ inputs.vcpkg-triplet }} -DVCPKG_HOST_TRIPLET=${{ inputs.vcpkg-triplet }} -DCMAKE_TOOLCHAIN_FILE=${{env.CMAKE_TC_FILE}} -DCMAKE_BUILD_TYPE=${{inputs.buildConf}} -DENABLE_CUDA=${{inputs.cuda}}'

    - name: Force cache update - save updated cache with newly-built packages
      if: ${{ always() && !inputs.is-selfhosted && inputs.force-cache-update }}
      uses: actions/cache/save@v3
      with:
        path: |
          ${{ inputs.cache-path }}
        key: ${{ inputs.flav }}-5-${{ hashFiles('base/vcpkg.json', 'vcpkg/baseline.json', 'submodule_ver.txt') }}

    - name: Build
      if: ${{!inputs.is-prep-phase}}
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --config ${{inputs.buildConf}} -j ${{ inputs.nProc }}

    - name: List Test cases
      if: ${{!inputs.is-prep-phase}}
      run: |
        ldd ${{env.TEST_EXE}} | tee >(grep 'not found') || true
        ${{env.TEST_EXE}} --list_content > tests.txt || true
      timeout-minutes: 1

    - name: Run Tests
      if: ${{!inputs.is-prep-phase && !inputs.skip-test}}
      run: |
        # Use xvfb-run for headless display on self-hosted runners (for GTK/EGL tests)
        if command -v xvfb-run &> /dev/null; then
          echo "Using Xvfb virtual display for headless testing"
          xvfb-run -a --server-args="-screen 0 1920x1080x24" ${{env.TEST_EXE}} --log_format=JUNIT --log_sink=CI_test_result_${{inputs.flav}}.xml -p -l all
        else
          ${{env.TEST_EXE}} --log_format=JUNIT --log_sink=CI_test_result_${{inputs.flav}}.xml -p -l all
        fi
      timeout-minutes: ${{ inputs.nTestTimeoutMins}}
    
    - name: Upload Test Results
      if: ${{ always() && !inputs.is-prep-phase && !inputs.skip-test }}
      continue-on-error: true
      uses: actions/upload-artifact@v4
      with:
        name: TestResults_${{ inputs.flav }}
        path: |
          CI_test_result_${{inputs.flav}}.xml
          ${{ github.workspace }}/data/SaveOrCompareFail/**
      

    - name: Upload build logs 
      if:  ${{ always() }} # only upload logs when we have a failure above
      uses: actions/upload-artifact@v4
      with:
        name: BuildLogs_${{ inputs.flav }}
        path: |
          ${{ github.workspace }}/vcpkg/buildtrees/**/*.log
          ${{ github.workspace }}/vcpkg/buildtrees/**/*.txt
          ${{ github.workspace }}/vcpkg_installed/vcpkg/*



