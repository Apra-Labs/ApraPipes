{
  "version": "1.0.0",
  "lastUpdated": "2025-12-10T04:20:00Z",
  "patterns": [
    {
      "id": "vcpkg-cache-tilde-expansion",
      "name": "vcpkg binary cache path uses tilde",
      "pattern": {
        "logMatch": "Environment variable VCPKG_DEFAULT_BINARY_CACHE must be a directory \\(was: ~/",
        "files": [".github/workflows/build-test-lin.yml"]
      },
      "diagnosis": {
        "issue": "vcpkg does not expand tilde (~) in environment variables",
        "rootCause": "VCPKG_DEFAULT_BINARY_CACHE set to path starting with ~",
        "severity": "high",
        "confidence": 100
      },
      "autoFix": {
        "enabled": true,
        "type": "workflow-edit",
        "actions": [
          {
            "file": ".github/workflows/build-test-lin.yml",
            "search": "VCPKG_DEFAULT_BINARY_CACHE: ~/",
            "replace": "VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/../",
            "commitMessage": "fix(ci): Use github.workspace instead of ~ for VCPKG_DEFAULT_BINARY_CACHE\n\nvcpkg does not expand tilde in environment variables."
          }
        ],
        "retryAfterFix": true
      },
      "successRate": 1.0,
      "occurrences": 1,
      "lastSeen": "2025-12-10T04:01:39Z"
    },
    {
      "id": "vcpkg-cache-home-expansion",
      "name": "vcpkg binary cache path uses $HOME",
      "pattern": {
        "logMatch": "Environment variable VCPKG_DEFAULT_BINARY_CACHE must be a directory \\(was: \\$HOME/",
        "files": [".github/workflows/build-test-lin.yml"]
      },
      "diagnosis": {
        "issue": "GitHub Actions does not expand shell variables like $HOME in env section",
        "rootCause": "VCPKG_DEFAULT_BINARY_CACHE set to path with $HOME instead of GitHub Actions expression",
        "severity": "high",
        "confidence": 100
      },
      "autoFix": {
        "enabled": true,
        "type": "workflow-edit",
        "actions": [
          {
            "file": ".github/workflows/build-test-lin.yml",
            "search": "VCPKG_DEFAULT_BINARY_CACHE: $HOME/",
            "replace": "VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/../",
            "commitMessage": "fix(ci): Use github.workspace instead of $HOME for VCPKG_DEFAULT_BINARY_CACHE\n\nGitHub Actions env section requires ${{ }} expressions, not shell variables."
          }
        ],
        "retryAfterFix": true
      },
      "successRate": 1.0,
      "occurrences": 1,
      "lastSeen": "2025-12-10T04:06:27Z"
    },
    {
      "id": "ffmpeg-gcc13-incompatibility",
      "name": "ffmpeg 4.4.3 fails with GCC 13.3",
      "pattern": {
        "logMatch": [
          "building ffmpeg:x64-linux failed",
          "src/libavcodec/x86/mathops.h:125: Error: operand type mismatch for .shr."
        ],
        "allMustMatch": true
      },
      "diagnosis": {
        "issue": "ffmpeg 4.4.3 assembly code incompatible with GCC 13.3",
        "rootCause": "Either GCC-13 is being used, OR vcpkg cache has packages built with GCC-13",
        "severity": "high",
        "confidence": 95
      },
      "autoFix": {
        "enabled": true,
        "type": "multi-step",
        "actions": [
          {
            "step": 1,
            "name": "Check current GCC version",
            "command": "ssh akhil@192.168.1.102 'gcc --version'",
            "condition": "if output contains 'gcc (Ubuntu 13.3', proceed to step 2, else proceed to step 3"
          },
          {
            "step": 2,
            "name": "Set GCC-12 as default (GCC-13 detected)",
            "command": "ssh akhil@192.168.1.102 'sudo /home/akhil/git/ApraPipes/build_scripts/setup-linux-cuda-runner.sh'",
            "description": "Run setup script to install and set GCC-12 as default"
          },
          {
            "step": 3,
            "name": "Clear vcpkg binary cache",
            "command": "ssh akhil@192.168.1.102 'rm -rf /home/akhil/actions-runner/_work/ApraPipes/.cache/vcpkg/*'",
            "description": "Remove GCC-13 compiled packages from cache",
            "estimatedSpaceFreed": "~4GB"
          },
          {
            "step": 4,
            "name": "Trigger rebuild",
            "command": "gh workflow run CI-Linux-CUDA.yml --ref $BRANCH",
            "description": "Retry build with clean cache and GCC-12"
          }
        ],
        "retryAfterFix": true,
        "maxRetries": 1
      },
      "successRate": 1.0,
      "occurrences": 3,
      "lastSeen": "2025-12-10T04:09:09Z",
      "notes": "This was the root cause in all 3 failed builds. Cache poisoning from GCC-13 packages."
    },
    {
      "id": "ninja-not-found-symptom",
      "name": "CMake cannot find Ninja (usually symptom)",
      "pattern": {
        "logMatch": "CMake was unable to find a build program corresponding to .Ninja."
      },
      "diagnosis": {
        "issue": "CMake reports Ninja not found, but this is usually a symptom of earlier vcpkg failure",
        "rootCause": "vcpkg install failed earlier in the log, causing CMake to fail at Ninja detection",
        "severity": "medium",
        "confidence": 90
      },
      "autoFix": {
        "enabled": true,
        "type": "log-analysis",
        "actions": [
          {
            "name": "Search for real error",
            "command": "grep -B 50 'CMake was unable to find.*Ninja' $LOG_FILE | grep -E '(error:|Error:|failed)'",
            "description": "Look for actual vcpkg error before the Ninja error"
          },
          {
            "name": "Delegate to actual error pattern",
            "description": "Once real error is found, apply fix for that pattern instead"
          }
        ],
        "retryAfterFix": false
      },
      "successRate": 0.0,
      "occurrences": 3,
      "lastSeen": "2025-12-10T04:09:09Z",
      "notes": "This error appeared in all 3 builds but was never the root cause. Always a symptom."
    },
    {
      "id": "disk-space-critical",
      "name": "Disk space > 90% on root partition",
      "pattern": {
        "healthCheck": "disk_usage_percent > 90",
        "partition": "/"
      },
      "diagnosis": {
        "issue": "Root partition disk space critical",
        "rootCause": "Build artifacts, Docker images, or vcpkg cache accumulation",
        "severity": "high",
        "confidence": 100
      },
      "autoFix": {
        "enabled": true,
        "type": "cleanup",
        "actions": [
          {
            "name": "Clean old build artifacts",
            "command": "ssh akhil@192.168.1.102 'find ~/actions-runner/_work -name build -type d -mtime +7 -exec rm -rf {} +'",
            "description": "Remove build folders older than 7 days"
          },
          {
            "name": "Clean vcpkg downloads",
            "command": "ssh akhil@192.168.1.102 'rm -rf ~/actions-runner/_work/ApraPipes/ApraPipes/vcpkg/downloads/*'",
            "description": "Clear vcpkg download cache (will re-download if needed)"
          },
          {
            "name": "Clean Docker images",
            "command": "ssh akhil@192.168.1.102 'docker image prune -a -f --filter \"until=30d\"'",
            "description": "Remove Docker images not used in 30 days"
          },
          {
            "name": "Report space freed",
            "command": "df -h /"
          }
        ],
        "retryAfterFix": true
      },
      "successRate": null,
      "occurrences": 0,
      "lastSeen": null,
      "notes": "Proactive check. Runner has 500GB disk, currently at 47%. Monitor trend."
    },
    {
      "id": "runner-offline",
      "name": "Self-hosted runner shows offline",
      "pattern": {
        "healthCheck": "runner_status == 'offline'",
        "runner": "linux-cuda"
      },
      "diagnosis": {
        "issue": "GitHub Actions runner service not responding",
        "rootCause": "Service crashed or machine unreachable",
        "severity": "critical",
        "confidence": 80
      },
      "autoFix": {
        "enabled": true,
        "type": "service-restart",
        "actions": [
          {
            "name": "Check if machine is reachable",
            "command": "ping -c 3 192.168.1.102",
            "onFailure": "escalate"
          },
          {
            "name": "Restart runner service",
            "command": "ssh akhil@192.168.1.102 'sudo systemctl restart actions.runner.Apra-Labs-ApraPipes.akhil-30ShattuckRoad01810.service'",
            "description": "Restart the GitHub Actions runner service"
          },
          {
            "name": "Wait for runner to come online",
            "command": "sleep 30"
          },
          {
            "name": "Verify runner is online",
            "command": "gh api /repos/Apra-Labs/ApraPipes/actions/runners | jq '.runners[] | select(.name==\"akhil/30ShattuckRoad01810\") | .status'",
            "expectedOutput": "online"
          }
        ],
        "retryAfterFix": true,
        "maxRetries": 2,
        "escalateOnFailure": true
      },
      "successRate": null,
      "occurrences": 0,
      "lastSeen": null
    },
    {
      "id": "test-flaky-failure",
      "name": "Test failures that pass on retry",
      "pattern": {
        "logMatch": "tests failed",
        "buildPassed": true,
        "testsFailed": true
      },
      "diagnosis": {
        "issue": "Tests failed but build compiled successfully",
        "rootCause": "Potentially flaky test or timing issue",
        "severity": "medium",
        "confidence": 60
      },
      "autoFix": {
        "enabled": true,
        "type": "retry-with-tracking",
        "actions": [
          {
            "name": "Retry build once",
            "command": "gh workflow run CI-Linux-CUDA.yml --ref $BRANCH",
            "description": "Single retry to check if test is flaky"
          },
          {
            "name": "Track retry result",
            "onSuccess": "Add test name to flaky-tests.json",
            "onFailure": "Create GitHub issue for persistent test failure"
          }
        ],
        "retryAfterFix": true,
        "maxRetries": 1
      },
      "successRate": null,
      "occurrences": 0,
      "lastSeen": null,
      "notes": "Not yet encountered, but good to have pattern ready"
    }
  ],
  "statistics": {
    "totalPatterns": 7,
    "autoFixablePatterns": 7,
    "encouneredIssues": 3,
    "successfulAutoFixes": 1,
    "learningRate": "High - new patterns added from CI-Linux-CUDA resurrection session"
  },
  "metadata": {
    "createdBy": "Claude Sonnet 4.5",
    "session": "CI-Linux-CUDA resurrection and monitoring system design",
    "notes": "This knowledge base was built from analyzing 3 failed builds and understanding the root causes. The ffmpeg/GCC-13 cache issue was particularly instructive."
  }
}
